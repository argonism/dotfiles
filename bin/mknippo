#! env python
# vim ft: python

from __future__ import print_function

import datetime
import os.path


HEADINGS = ['Done', 'Work in Progress', 'Todo', 'Trouble', 'TIL']
HEADINGS_NEEDED_TAKE_OVER = ['Work in Progress', 'Todo']


def format_datetime(datetime, with_extension=True):
    '''
    datetime: datetime.datetime
    with_extension: bool
    '''
    datetime_str = datetime.strftime('%Y:%m:%d')
    if with_extension:
        return datetime_str + '.md'
    else:
        return datetime_str


def extract_previous_entries(nippo_text, entry):
    '''
    nippo_text: str
    entry: str
    '''
    in_state = False
    previous_entries = ''
    entry_key = '## ' + entry

    for line in nippo_text.split('\n'):
        if entry_key in line:
            in_state = True
            continue

        if in_state:
            previous_entries += line + '\n'

        if in_state and line == '':
            break

    previous_entries = previous_entries.rstrip('\n')
    return previous_entries


def create_nippo(previous_entries):
    '''
    previous_entries: Dict[str, str]
    '''

    nippo_text = ''
    for heading in HEADINGS:
        nippo_text += '## ' + heading + '\n'
        if heading in previous_entries:
            previous_text = previous_entries[heading]
            nippo_text += previous_text + '\n'

        nippo_text += '- <`1:`>\n'
        nippo_text += '\n'

    nippo_text = nippo_text.rstrip('\n')
    return nippo_text


if __name__ == '__main__':
    today = datetime.datetime.now()
    today_string = format_datetime(today)

    if os.path.exists(today_string):
        print('You have already written nippo!')
        exit()

    # tack the previous nippo
    previous_entries = {}
    for delta_ in range(1, 31):
        delta = datetime.timedelta(days=delta_)
        previous_day = today - delta
        previous_day_string = format_datetime(previous_day)
        if os.path.exists(previous_day_string):
            print('Found the previous nippo')

            with open(previous_day_string) as previous_nippo_file:
                previous_nippo = previous_nippo_file.read()
                for heading in HEADINGS_NEEDED_TAKE_OVER:
                    tmp_ = extract_previous_entries(previous_nippo, heading)
                    previous_entries[heading] = tmp_
            break

    today_nippo_text = '# ' + format_datetime(today) + '\n\n'
    today_nippo_text += create_nippo(previous_entries)
    with open(today_string, 'w') as today_nippo:
        print(today_nippo_text, file=today_nippo)
    print('created: ' + today_string)
